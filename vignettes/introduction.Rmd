---
title: "Introduction to ggsunburst"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to ggsunburst}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 7
)
```

```{r setup}
library(ggsunburst)
library(ggplot2)
```

## Overview
 
The ggsunburst package creates trajectory-based sunburst visualizations showing how groups of subjects flow between categories over time. Unlike traditional sunburst charts that show hierarchical proportions at a single point in time, trajectory sunbursts reveal **longitudinal patterns** and **transitions**.

### Key Concepts

- **Inner ring** = earliest timepoint (e.g., Baseline)
- **Outer rings** = subsequent timepoints (e.g., Week 4, Week 8, Week 12)
- **Segment width** = number of subjects on that trajectory path
- **Colors** = category at each timepoint
- **Radial slices** = individual trajectory paths from center to edge

## Quick Start

### Generate Example Data

```{r generate-data}
# Create simulated trajectory data
traj_data <- create_example_trajectory_data(
  n_subjects = 80,
  n_timepoints = 4,
  transition_tendency = "moderate",
  seed = 42
)

head(traj_data)
```

### Create Basic Trajectory Sunburst

```{r basic-plot, fig.alt="Basic trajectory sunburst chart"}
sunburst_trajectory(
  traj_data,
  subject = "subject",
  time = "visit",
  category = "grade",
  palette = "ctcae",
  title = "AE Grade Trajectories Over Time"
)
```

## Reading the Chart

To interpret a trajectory sunburst:

1. **Start at the center**: The innermost ring shows the distribution at the first timepoint
2. **Move outward**: Each ring represents a subsequent timepoint
3. **Follow a radial slice**: Any path from center to edge represents one unique trajectory
4. **Segment width**: Wider segments = more subjects following that path
5. **Color changes**: When colors change moving outward, subjects transitioned between categories

For example:
- A wide green slice that stays green from center to edge = many subjects who stayed at Grade 1 throughout
- A segment that goes green → yellow → orange = subjects whose grade worsened over time

## Handling Missing Data (Non-Rectangular Datasets)

Real clinical data often has dropouts. The `missing_handling` parameter controls how incomplete data is displayed.

### Create Data with Dropouts

```{r dropout-data}
dropout_data <- create_example_trajectory_data(
  n_subjects = 100,
  n_timepoints = 4,
  dropout_rate = 0.25,  # 25% dropout per timepoint
  seed = 123
)

# Check subjects per visit
table(dropout_data$visit)
```

### Option 1: "dropout" (Default) - Invisible Gaps

Discontinued subjects are drawn invisibly, preserving angular space and creating an uneven outer border that shows where dropouts occurred.

```{r dropout-invisible, fig.alt="Sunburst with dropout gaps"}
sunburst_trajectory(
  dropout_data,
  subject = "subject",
  time = "visit",
  category = "grade",
  missing_handling = "dropout",
  palette = "ctcae",
  title = "Dropout Handling: Gaps",
  subtitle = "Uneven outer border shows where patients dropped out"
)
```

### Option 2: "carry_forward" - LOCF Imputation

Last Observation Carried Forward imputes missing values with the most recent observed category.

```{r locf, fig.alt="Sunburst with LOCF imputation"}
sunburst_trajectory(
  dropout_data,
  subject = "subject",
  time = "visit",
  category = "grade",
  missing_handling = "carry_forward",
  palette = "ctcae",
  title = "Dropout Handling: LOCF",
  subtitle = "Missing visits use last observed value"
)
```

### Option 3: "complete_only" - Exclude Incomplete

Only subjects with data at all timepoints are included.
 
```{r complete-only, fig.alt="Sunburst with complete cases only"}
sunburst_trajectory(
  dropout_data,
  subject = "subject",
  time = "visit",
  category = "grade",
  missing_handling = "complete_only",
  palette = "ctcae",
  title = "Dropout Handling: Complete Cases Only",
  subtitle = "Only subjects with all visits included"
)
```

### Option 4: "show_missing" - Explicit Missing Category

Missing observations shown as a separate "Missing" category.

```{r show-missing, fig.alt="Sunburst with missing category"}
# Create data with intermittent missing (not just dropouts)
set.seed(456)
intermittent_data <- create_example_trajectory_data(n_subjects = 60, seed = 456)
# Remove some middle visits
remove_idx <- sample(which(intermittent_data$visit == "Week 4"), 10)
intermittent_data <- intermittent_data[-remove_idx, ]

sunburst_trajectory(
  intermittent_data,
  subject = "subject",
  time = "visit",
  category = "grade",
  missing_handling = "show_missing",
  palette = "ctcae",
  title = "Dropout Handling: Show Missing",
  subtitle = "Missing visits shown as separate category"
)
```

## Label Customization

### Label Orientation

Control how labels are oriented within segments:

- **auto** (default): Chooses best orientation based on segment shape
- **radial**: Text reads from center outward
- **tangential**: Text follows the arc
- **horizontal**: Text is always horizontal

```{r label-orientation, fig.alt="Label orientation options"}
sunburst_trajectory(
  traj_data, subject = "subject", time = "visit", category = "grade",
  label_orientation = "radial",
  palette = "ctcae",
  title = "Radial Label Orientation"
)
```

### Auto-Fit Labels

Control automatic label sizing and filtering:

```{r autofit-labels, fig.alt="Auto-fit label demonstration"}
sunburst_trajectory(
  traj_data,
  subject = "subject",
  time = "visit",
  category = "grade",
  palette = "ctcae",
  fit_labels = TRUE,          # Enable auto-fitting
  label_size = 4,             # Base size
  label_min_size = 2,         # Minimum size
  label_max_size = 6,         # Maximum size
  title = "Auto-Fit Labels",
  subtitle = "Labels sized to fit segments, small segments hidden"
)
```

### Label Content

Choose what information to display with `show_labels`:

- `"percent"` (default): Show percentage of total
- `"count"`: Show absolute count
- `"category"`: Show category name
- `"none"`: No labels

## Color Palettes

### Built-in Palettes

```{r palettes, fig.alt="Color palette options"}
# CTCAE colors (standard AE grading)
sunburst_trajectory(
  traj_data, subject = "subject", time = "visit", category = "grade",
  palette = "ctcae",
  title = "CTCAE Palette"
)
```

### Custom Palettes

```{r custom-palette, fig.alt="Custom color palette"}
custom_colors <- c(
  "0" = "#f7f7f7",
  "1" = "#ccece6",
  "2" = "#66c2a4",
  "3" = "#238b45",
  "4" = "#00441b"
)

sunburst_trajectory(
  traj_data,
  subject = "subject",
  time = "visit",
  category = "grade",
  palette = custom_colors,
  title = "Custom Green Palette"
)
```

## Additional Annotations

### Center Labels

Add text to the center of the chart:

```{r center-label, fig.alt="Sunburst with center label"}
sunburst_trajectory(
  traj_data,
  subject = "subject",
  time = "visit",
  category = "grade",
  palette = "ctcae",
  title = "Study XYZ: AE Trajectories"
) |>
  add_center_label("N=80\nPatients", size = 5)
```

## Tumor Response Example

The package includes a function for generating tumor response trajectory data:

```{r tumor-response, fig.alt="Tumor response trajectory"}
response_data <- create_example_response_trajectory(
  n_subjects = 60,
  seed = 789
)

sunburst_trajectory(
  response_data,
  subject = "subject",
  time = "timepoint",
  category = "response",
  category_order = c("CR", "PR", "SD", "PD"),
  palette = c(
    "CR" = "#1a9850",
    "PR" = "#91cf60",
    "SD" = "#d9d9d9",
    "PD" = "#d73027"
  ),
  title = "Tumor Response Trajectories",
  subtitle = "CR=Complete, PR=Partial, SD=Stable, PD=Progressive"
)
```

## Comparing Transition Dynamics

Use `transition_tendency` to simulate different levels of category stability:

```{r transition-dynamics, fig.alt="Transition dynamics comparison"}
# Stable - subjects tend to stay in same category
stable_data <- create_example_trajectory_data(
  n_subjects = 80, transition_tendency = "stable", seed = 111
)

sunburst_trajectory(
  stable_data, subject = "subject", time = "visit", category = "grade",
  palette = "ctcae", title = "Stable (70% stay probability)"
)
```

In stable charts, you'll see more uniform color bands (subjects staying in the same category). In dynamic charts, there's more color variation as subjects transition between categories.

## Integration with ggplot2

Since `sunburst_trajectory()` returns a ggplot2 object, you can further customize it:

```{r ggplot-integration, fig.alt="Customized sunburst"}
sunburst_trajectory(
  traj_data,
  subject = "subject",
  time = "visit",
  category = "grade",
  palette = "ctcae",
  title = "Customized Sunburst"
) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    legend.position = "bottom"
  ) +
  labs(caption = "Data source: Simulated clinical trial")
```

## Summary

The ggsunburst package provides:

- **Trajectory visualization**: See how subjects flow between categories over time
- **Flexible missing data handling**: Choose how to display dropouts and incomplete data
- **Label customization**: Control orientation, size, and content of labels
- **Color palettes**: Built-in and custom color schemes
- **ggplot2 integration**: Full compatibility with ggplot2 customization

For more details, see the function documentation with `?sunburst_trajectory`.
