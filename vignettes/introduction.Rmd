---
title: "Introduction to ggsunburst"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to ggsunburst}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 7
)
```

## Overview

The `ggsunburst` package creates sunburst (multilevel pie) charts using ggplot2. Sunburst charts display hierarchical data as concentric rings, where each ring represents a level in the hierarchy or a time point.

This package is particularly useful for:

- **Adverse event visualization**: Track changes in AE grades over time at the individual patient level
- **Hierarchical data**: Display nested categories like organizational structures, file systems, or taxonomies
- **Longitudinal patterns**: Visualize how categorical variables change over time for multiple subjects

## Installation

```{r eval=FALSE}
# From GitHub (once published)
# remotes::install_github("occams/ggsunburst")

# Or install from local source
# install.packages("path/to/ggsunburst", repos = NULL, type = "source")
```

## Quick Start

```{r message=FALSE}
library(ggsunburst)
library(ggplot2)
```

### Basic Adverse Event Visualization

The primary use case for `ggsunburst` is visualizing adverse event grades over time:

```{r}
# Generate example AE data
ae_data <- create_example_ae_data(n_patients = 20, seed = 42)
head(ae_data)
```

Create a sunburst chart with the `sunburst_ae()` function:

```{r}
sunburst_ae(
  ae_data,
  subject = "USUBJID",
  time = "AVISIT",
  grade = "AETOXGR",
  title = "Adverse Event Grades Over Time",
  subtitle = "Individual patient trajectories"
)
```

### Understanding the Chart

In this visualization:

- **Each slice** represents one patient (labeled around the outside)
- **Each ring** represents a time point (from center outward: Screening â†’ Week 12)
- **Colors** indicate the AE grade at that time point (using CTCAE color scale)

### Sorting Options

Patients can be sorted in different ways to highlight patterns:

```{r}
# Sort by maximum grade experienced (default)
sunburst_ae(
  ae_data,
  subject = "USUBJID",
  time = "AVISIT", 
  grade = "AETOXGR",
  sort_by = "max_grade",
  title = "Sorted by Maximum Grade"
)
```

```{r}
# Sort by last observed grade
sunburst_ae(
  ae_data,
  subject = "USUBJID",
  time = "AVISIT",
  grade = "AETOXGR",
  sort_by = "last_grade",
  title = "Sorted by Final Grade"
)
```

## General Sunburst Charts

For non-AE data, use the more general `sunburst()` function:

### Wide Format Data

When your time points or hierarchy levels are in separate columns:
```{r}
# Create example wide data
set.seed(123)
wide_data <- data.frame(
  id = paste0("Subject_", 1:12),
  Baseline = sample(c("Low", "Medium", "High"), 12, replace = TRUE),
  Month_3 = sample(c("Low", "Medium", "High"), 12, replace = TRUE),
  Month_6 = sample(c("Low", "Medium", "High"), 12, replace = TRUE),
  Month_12 = sample(c("Low", "Medium", "High"), 12, replace = TRUE)
)

sunburst(
  wide_data,
  segments = "id",
  rings = c("Baseline", "Month_3", "Month_6", "Month_12"),
  palette = c("Low" = "#93C47D", "Medium" = "#FFD966", "High" = "#CC0000"),
  legend_title = "Severity",
  title = "Treatment Response Over Time"
)
```

### Long Format Data

When your data is in tidy/long format:

```{r}
# Long format example
long_data <- data.frame(
  patient = rep(LETTERS[1:8], each = 4),
  visit = rep(c("V1", "V2", "V3", "V4"), 8),
  score = factor(sample(1:4, 32, replace = TRUE))
)

sunburst(
  long_data,
  segments = "patient",
  rings = "visit",
  fill = "score",
  palette = "Blues",
  legend_title = "Score",
  title = "Patient Scores Across Visits"
)
```

## Customization

### Color Scales

The package includes several built-in color scales:

```{r}
# CTCAE grade colors (default for AE data)
p1 <- sunburst_ae(ae_data, "USUBJID", "AVISIT", "AETOXGR",
                   palette = "ctcae", title = "CTCAE Colors")
p1
```

For custom colors, pass a named vector:

```{r}
custom_colors <- c(
  "0" = "#f7f7f7",
  "1" = "#d9f0d3", 
  "2" = "#a6dba0",
  "3" = "#5aae61",
  "4" = "#1b7837"
)

sunburst_ae(
  ae_data, "USUBJID", "AVISIT", "AETOXGR",
  palette = custom_colors,
  title = "Custom Green Gradient"
)
```

### Themes

Apply the `theme_sunburst()` for fine control:

```{r}
sunburst_ae(ae_data, "USUBJID", "AVISIT", "AETOXGR") +
  theme_sunburst(
    base_size = 12,
    legend_position = "bottom",
    title_position = "center"
  ) +
  labs(title = "Custom Theme Applied")
```

### Adding a Center Label

Use `add_center_label()` to add text to the center:

```{r}
p <- sunburst_ae(ae_data, "USUBJID", "AVISIT", "AETOXGR",
                  title = "AE Grade Trajectories")

add_center_label(p, label = "N=20\nPatients", size = 4)
```

### Controlling Labels

```{r}
# Show value labels in cells (useful for smaller datasets)
sunburst_ae(
  create_example_ae_data(n_patients = 8, seed = 1),
  subject = "USUBJID",
  time = "AVISIT",
  grade = "AETOXGR",
  show_grade_labels = TRUE,  # Force labels on
  title = "With Cell Labels"
)
```

## Faceted Sunbursts

For multiple adverse events or subgroups, use faceting:

```{r fig.width=10, fig.height=8}
# Create data with multiple AE types
set.seed(42)
multi_ae <- data.frame(
  USUBJID = rep(paste0("S", sprintf("%02d", 1:12)), each = 12),
  AVISIT = rep(rep(c("BL", "W4", "W8", "W12"), each = 3), 12),
  AETERM = rep(c("Nausea", "Fatigue", "Headache"), 48),
  AETOXGR = sample(0:3, 144, replace = TRUE, prob = c(0.4, 0.35, 0.2, 0.05))
)

sunburst_ae_faceted(
  multi_ae,
  subject = "USUBJID",
  time = "AVISIT",
  grade = "AETOXGR",
  facet = "AETERM",
  ncol = 3
)
```

## Working with ggplot2

Since `ggsunburst` returns ggplot2 objects, you can add any ggplot2 components:

```{r}
sunburst_ae(ae_data, "USUBJID", "AVISIT", "AETOXGR") +
  labs(
    title = "Study XYZ-001: Adverse Event Profile",
    subtitle = "Grade distribution by visit",
    caption = "Data as of 2025-01-01"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "bottom"
  )
```

## Advanced: Building from Components

For maximum control, you can use the component functions directly:

```{r}
# Prepare data manually
prepared <- prepare_sunburst_data(
  ae_data,
  segments = "USUBJID",
  rings = "AVISIT",
  fill = "AETOXGR",
  segment_order = "alphabetical",
  inner_radius = 0.3,
  ring_gap = 0.08
)

# Build plot manually
ggplot(prepared) +
  geom_sunburst_rect() +
  coord_polar(theta = "x", start = 0) +
  scale_fill_ctcae() +
  theme_void() +
  ylim(0, max(prepared$ymax) * 1.2)
```

## Best Practices

1. **Number of subjects**: Sunbursts work best with 10-50 subjects. More than that makes individual segments hard to read.

2. **Number of time points**: 3-8 rings are ideal. Too many rings make the inner rings very small.

3. **Sorting**: Sort by maximum grade to group patients with similar severity profiles together.

4. **Labels**: Use segment labels (patient IDs) for smaller datasets. For larger datasets, consider suppressing them.

5. **Colors**: The CTCAE color scale is designed to be intuitive (green = mild, red = severe) and colorblind-friendly.

## Session Info

```{r}
sessionInfo()
```
